# 動作環境

動作確認は以下の環境で実施
ruby 2.7.1p83 (2020-03-31 revision a0c7c23c9c) [x86_64-linux-gnu]

# 実行方法

 * 展開したディレクトリに cd する(require "./common.rb" とか書いてる箇所があるので cd しないと動きません)
 * 移動した先のディレクトリに http://www.post.japanpost.jp/zipcode/dl/kogaki/zip/ken_all.zip を展開して出てくる KEN_ALL.CSV を置く
 * create_index.rb を実行してインデクスファイルを生成する(address.idx というファイルが生成される)
 * search.pl で検索する、検索対象は引数で指定

    例: ./search.pl 渋谷

# コメント

インデクスの作成とか検索まわりは common.rb の NgramIndex class にまとめてある。

検索インデクスは

 * アドレスエントリのリスト(配列)
 * 検索用のngramインデクスは、上記のエントリの添字の配列を持つ

というような構造になっている。


例えば


```
addresses = [["0101642","秋田県","秋田市","新屋渋谷町"], ["1500042","東京都","渋谷区","宇田川町"]]
```

である場合、ngramインデクスは


```
index = {"秋田" => [0], "田県" => [0], "渋谷" => [0,1], "東京" => [1] (... 以下省略) }
```

といった形式になる。インデクスファイルにはこの2つが格納されている。


この住所データを扱う際にいつも問題になる/話題になる複数行に分割されてるデータの扱いに関しては、そもそもが処理しづらい仕様なので、処理がかなりぐちゃっとなってしまっているし、書き方もあまりきれいではないように思える。

そもそもの入力データサイズがあまり大きくない(CSVで12MB程度)ことと、実装にさける時間も限られていることから処理として楽そうで速度も出るだろうということでインデクスはオンメモリでhashを作ってそれをMarshalでdump/loadするという形式にした。

 * ngramなのでインデクスの作成には時間がかかるわけで(といってもデータサイズが小さいので今回は実際はたいしたことないが)、オンメモリでインデクスが作成できるようなら、速度面ではそれなりに意味はありそう。
 * Marshal使うのはruby以外からの読み出しが難しくなる等汎用性が高いとは言えずbetterな方法ではないのかなぁと思う。インデクス自体はhashだし中身はtextで表現できるものばかりでbinaryデータは入ってないのでjsonで吐く等も考えたが、ファイルサイズ的にはjsonの方が大きくなりそうだし、jsonだとロード時の毎回のパースが重そうなのでひとまずruby的さくっと使えるMarshalで実装してしまった。このあたりはどうするのがbetterなのだろう?
 * オンメモリのhashでの検索なのでインデクスをひくこと自体は速いはずだけど、今回のように検索が簡単なコマンドラインのツールとなると、開始ごとにインデクスファイルのロードが必要なのでその分の処理時間が気になるかもしれない。ロードの影響が小さく見えるように、ロードしたあと常駐する検索daemon的にでもするとか工夫してあるとbetterだろうなぁと思う。
 * hashに載せきれないようなもっと大きなデータなのであれば、例えばdbm使うとか、それでも手に負えないさらにデカイならDBとか他の手段に頼ることになるだろう

# 仕様の曖昧さに対する追加仕様

 * 出力に関しては郵便番号と漢字の住所だという指定があるが、検索対象となるカラムの指定がないのでフリガナとか郵便番号等での検索に関してどうするべきか不明である。今回は表示対象である「都道府県名」「市区町村名」「町域名」(元データのカラムでいうと0スタートで数えて 6,7,8 番カラム)のみを検索対象とした(ので、郵便番号とかフリガナでの検索はできない)

 * 「スペースは文字として扱わない」とあるが、この表現だと例えば "あいう えお" という検索文字列が与えられた場合、スペースをのぞいて "あいうえお" という文字列として扱うべきだという指示なのか、あるいは他のなにかの処理をすべきなのか(例えばよくあるように "あいう"と"えお" の AND 検索とか)指示がない。とりあえず、スペースがあるケースは単に無視するように実装した(この例で言うと"あいう えお" は "あいうえお" として処理されて検索される)

 * 「スペースは文字として扱わない」とあるが、他の空白文字やその他各種文字に関しては特に指定がないのでそのまま処理している(例えば検索対象文字列にLF文字が含まれていればそれはLF文字として扱われる)

# 参考文献
住所データ | http://www.post.japanpost.jp/zipcode/dl/kogaki/zip/ken_all.zip


日本郵便の郵便番号データ ken_all をどうにかする | https://blog1.mammb.com/entry/2020/02/11/015807

各カラムの仕様の説明はこれがわかりやすい/比較的新しい。問題の複数行レコードに関する説明もある。

# Copyright

2020 ISHIKAWA Mutsumi
